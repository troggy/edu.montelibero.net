<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MTL EDU Loan Transaction Generator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@stellar/stellar-sdk@12.2.0/dist/stellar-sdk.min.js"></script>
</head>

<body>
  <section class="section">
    <div class="container">
      <h1 class="title is-2">MTL EDU Loan Transaction Generator</h1>
      <h2 class="title is-4">Step 1. Generate Transaction <a class="is-link is-size-7 ml-2"
          onClick="toggle('generateHelp')">help</a></h2>

      <div class="box is-hidden" id="generateHelp">
        <p>Generated transaction will do the following operations:
        <ul>
          <li>- open trustline to Debt Token on Fund Fund Account</li>
          <li>- send given amount of EURMTL from Fund Account to Borrower Account</li>
          <li>- mint and send same amount of Debt Token from Borrower Account to Fund Account</li>
        </ul>
        </p>
        <br />
        <p>Debt token token name will be random starting with MTLEDU prefix</p>
        <p></p>
      </div>
      <form id="loanForm" class="mb-5">
        <div class="field">
          <label class="label" for="amount">Loan Amount:</label>
          <div class="control">
            <input class="input" type="number" id="amount" required>
          </div>
        </div>

        <div class="field">
          <label class="label" for="borrowerAddress">Borrower Address:</label>
          <div class="control">
            <input class="input" type="text" id="borrowerAddress" required>
          </div>
        </div>

        <div class="field">
          <label class="label" for="fundAddress">Fund Address:</label>
          <div class="control">
            <input class="input" type="text" id="fundAddress" required>
          </div>
        </div>

        <div class="field">
          <div class="control">
            <button type="submit" class="button is-primary">Generate Transaction</button>
          </div>
        </div>
      </form>
    </div>
    <div class="container is-hidden" id="resultContainer">
      <h2 class="title is-4">Step 2. Sign transaction <a class="is-link is-size-7 ml-2"
          onClick="toggle('signHelp')">help</a></h2>
      <div class="box is-hidden" id="signHelp">
        <p>Transaction needs to be signed by both Borrower and Fund, so it is multisig.</p>
        <p>The easiest way to do this is to add XDR to <a href="https://eurmtl.me/sign_tools" target="_blank">EURMTL
            Sign Tools</a>:</p>
        <p>
        <ul>
          <li>- paste XDR to Sign Tools, add some description and click 'Create'</li>
          <li>- sign tx with Fund Private Key (may be done on Sign Tools directly or in MyMTLWallet or in Stellar
            Laboratory)</li>
          <li>- share the link with Borrower so he can sign too</li>
          <li>- once both signed, submit tx to the network (can be done in Sign Tools)</li>
        </ul>
        </p>
      </div>
      <h2 class="subtitle">Transaction XDR:</h2>
      <div id="result" class="box has-background-light mb-3" style="word-wrap: break-word"></div>

      <button id="copyButton" class="button is-info">Copy to Clipboard</button>
      <button id="openSignToolsButton" class="button is-link">Open EURMTL Sign Tools</button>
    </div>
    <div id="messageContainer" class="container mt-3"></div>
  </section>


  <script>
    const toggle = (elementId) => {
      const el = document.getElementById(elementId);
      if (el.classList.contains('is-hidden')) {
        el.classList.remove('is-hidden')
      } else {
        el.classList.add('is-hidden')
      }
    };

    const storedFundAddress = localStorage.getItem('fundAddress');
    if (storedFundAddress) {
      document.getElementById('fundAddress').value = storedFundAddress;
    }

    function showMessage(message, isError = false) {
      const messageContainer = document.getElementById('messageContainer');
      messageContainer.innerHTML = `
        <div class="notification ${isError ? 'is-danger' : 'is-success'}">
          <button class="delete"></button>
          ${message}
        </div>
      `;
      messageContainer.querySelector('.delete').addEventListener('click', function () {
        messageContainer.innerHTML = '';
      });
    }

    async function createLoanTransaction(assetName, amount, fundAccountPubKey, borrowerAccountPubKey) {
      const server = new StellarSdk.Horizon.Server('https://horizon.stellar.org');
      const fundAccount = await server.loadAccount(fundAccountPubKey);
      const debtAsset = new StellarSdk.Asset(assetName, borrowerAccountPubKey);
      const eurmtlAsset = new StellarSdk.Asset('EURMTL', 'GACKTN5DAZGWXRWB2WLM6OPBDHAMT6SJNGLJZPQMEZBUR4JUGBX2UK7V');

      const transaction = new StellarSdk.TransactionBuilder(fundAccount, {
        fee: await server.fetchBaseFee(),
        networkPassphrase: StellarSdk.Networks.PUBLIC,
      })
        .addOperation(StellarSdk.Operation.changeTrust({
          asset: debtAsset,
        }))
        .addOperation(StellarSdk.Operation.payment({
          source: borrowerAccountPubKey,
          destination: fundAccountPubKey,
          asset: debtAsset,
          amount: amount,
        }))
        .addOperation(StellarSdk.Operation.payment({
          destination: borrowerAccountPubKey,
          asset: eurmtlAsset,
          amount: amount,
        }))
        .setTimeout(7 * 24 * 60 * 60)
        .build();

      return transaction.toXDR();
    }

    document.getElementById('openSignToolsButton').addEventListener('click', function () {
      window.open('https://eurmtl.me/sign_tools', '_blank');
    });

    document.getElementById('copyButton').addEventListener('click', function () {
      const xdr = document.getElementById('result').textContent;
      navigator.clipboard.writeText(xdr).then(function () {
        showMessage('Transaction XDR copied to clipboard!');
      }, function (err) {
        console.error('Could not copy text: ', err);
        showMessage('Could not copy text to clipboard.', true);
      });
    });

    document.getElementById('loanForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const amount = document.getElementById('amount').value;
      const borrowerAddress = document.getElementById('borrowerAddress').value;
      const fundAddress = document.getElementById('fundAddress').value;
      localStorage.setItem('fundAddress', fundAddress);
      const assetName = `MTLEDU${String(Math.floor(Math.random() * 9999) + 1).padStart(4, '0')}`;

      try {
        const xdr = await createLoanTransaction(assetName, amount, fundAddress, borrowerAddress);
        document.getElementById('resultContainer').classList.remove('is-hidden');
        document.getElementById('result').textContent = xdr;
      } catch (error) {
        showMessage(`Error: ${error.message}`, true);
      }
    });
  </script>
</body>

</html>